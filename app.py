import streamlit as st
import urllib.parse 

st.set_page_config(page_title="‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", layout="centered")

# -----------------------------------------------------------
# --- CSS: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏î‡∏≥ + ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ç‡∏≠‡∏ö‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô (Wongnai Style) ---
# -----------------------------------------------------------
st.markdown(
    """
    <style>
    /* 1. ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏´‡∏•‡∏±‡∏Å (‡∏Ç‡∏≤‡∏ß‡∏™‡∏∞‡∏≠‡∏≤‡∏î) */
    .stApp {
        background-color: #FFFFFF !important; 
    }
    
    /* 2. ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏î‡∏≥‡∏™‡∏ô‡∏¥‡∏ó */
    .stApp, .stMarkdown, .stText {
        color: #000000 !important; 
    }
    
    /* 3. ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ Sidebar ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß */
    .css-1d3f9sd, .css-1dp5q0n {
        background-color: #FFFFFF !important;
    }

    /* 4. ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å (Title, Subheader) ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏°‡πÅ‡∏ö‡∏ö Wongnai */
    h1, h2, h3 {
        color: #002244 !important; /* ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏° */
    }

    /* 5. ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏ô Input/Textarea/Password/Slider/Alerts ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏î‡∏≥ */
    .stTextInput>div>div>input, 
    .stTextArea>div>div>textarea,
    .stSlider label,
    .stAlert {
        color: #000000 !important;
    }
    /* Placeholder text (‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á) */
    input::placeholder {
        color: #666666 !important; 
    }

    /* 6. ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å (Primary) - ‡∏™‡∏µ‡∏™‡πâ‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå Wongnai (‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß, ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö) */
    .stButton>button {
        background-color: #FF5722; /* ‡∏™‡∏µ‡∏™‡πâ‡∏°‡πÅ‡∏ö‡∏ö Wongnai */
        color: #FFFFFF !important; /* ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡πÉ‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏™‡πâ‡∏° */
        border: 1px solid #FF5722;
        border-radius: 8px;
        font-weight: bold; /* ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤ */
    }
    
    /* 7. ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏≠‡∏á (Secondary) - ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå (‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î, ‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÉ‡∏à, Favorite) */
    .stButton>button:has(.streamlit-emoji-icon) {
        background-color: #FFFFFF; 
        color: #002244 !important; /* ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏° */
        border: 2px solid #002244; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏ö‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏î‡πÄ‡∏î‡πà‡∏ô‡∏à‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≤‡∏ß */
    }
    
    /* 8. Input Fields - ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏Ç‡∏≠‡∏ö‡πÄ‡∏ó‡∏≤ */
    .stTextInput>div>div>input, 
    .stTextArea>div>div>textarea {
        background-color: #F8F8F8;
        border: 1px solid #CCCCCC;
        border-radius: 4px;
    }

    /* 9. ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (st.info) */
    .stAlert:has(.streamlit-badge-info) {
        background-color: #E6F7FF; /* ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
        border: 1px solid #002244;
    }

    </style>
    """,
    unsafe_allow_html=True
)
# -----------------------------------------------------------

# -----------------------------------------------------------
# --- ‡πÇ‡∏•‡πÇ‡∏Å‡πâ ---
# -----------------------------------------------------------
# ‚ùó‚ùó ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL/‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ ‚ùó‚ùó
st.image(
    "https://i.ibb.co/your-logo-image.png", # <--- ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ URL ‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå ‡πÄ‡∏ä‡πà‡∏ô "my_logo.png")
    width=150
)
# -----------------------------------------------------------


# -------------------------------
# üîê ‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡∏à‡∏≥‡∏•‡∏≠‡∏á)
# -------------------------------
if "users" not in st.session_state:
    st.session_state.users = {"admin": "1234", "user01": "pass"}
if "logged_in" not in st.session_state:
    st.session_state.logged_in = False
if "current_user" not in st.session_state:
    st.session_state.current_user = ""
if "search_history" not in st.session_state:
    st.session_state.search_history = []
if "favorites" not in st.session_state:
    st.session_state.favorites = {} # {username: set_of_restaurant_names}
if "view_mode" not in st.session_state:
    st.session_state.view_mode = "all" # 'all' ‡∏´‡∏£‡∏∑‡∏≠ 'favorites'
if "search_input_key" not in st.session_state:
    st.session_state.search_input_key = ""
if "reviews" not in st.session_state:
    st.session_state.reviews = []
    

# ----------------------------------------------------------------------------------
# üõ†Ô∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Google Maps URL (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ URL ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)
# ----------------------------------------------------------------------------------
def create_google_maps_url(name, town="‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ"):
    """‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà Google Maps ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö URL ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (Search Query)"""
    
    # 1. ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
    query = f"{name} {town}"
    encoded_query = urllib.parse.quote_plus(query)
    
    # 2. ‡πÉ‡∏ä‡πâ URL ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á Google Maps ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á: "https://www.google.com/maps/search/?api=1&query="
    # ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡πÑ‡∏î‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î Google Maps ‡∏à‡∏£‡∏¥‡∏á‡πÜ 
    return f"https://www.google.com/maps/search/?api=1&query={encoded_query}"


# ----------------------------------------------------------------------------------
# ‚ùó ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å
# ----------------------------------------------------------------------------------
def set_search_from_button(query):
    """‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ st.session_state.search_input_key ‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÅ‡∏•‡∏∞‡∏™‡∏±‡πà‡∏á Rerun"""
    st.session_state.search_input_key = query 
    
    query_to_save = query.strip()
    if query_to_save and query_to_save not in st.session_state.search_history:
        st.session_state.search_history.insert(0, query_to_save)
        st.session_state.search_history = st.session_state.search_history[:5]
        
    st.rerun()

def reset_search():
    """‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Search ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á, ‡∏ï‡∏±‡πâ‡∏á View Mode ‡πÄ‡∏õ‡πá‡∏ô 'all' ‡πÅ‡∏•‡∏∞‡∏™‡∏±‡πà‡∏á rerun"""
    st.session_state.view_mode = "all"
    set_search_from_button("") 

def switch_to_favorites():
    st.session_state.view_mode = "favorites"
    st.session_state.search_input_key = "" # ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î
    st.rerun()

def toggle_favorite(restaurant_name):
    """‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö ‡∏£‡πâ‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô"""
    current_user = st.session_state.current_user
    
    if current_user not in st.session_state.favorites:
        st.session_state.favorites[current_user] = set()
        
    user_favorites = st.session_state.favorites[current_user]

    if restaurant_name in user_favorites:
        user_favorites.remove(restaurant_name)
        st.toast(f"üíî ‡∏•‡∏ö '{restaurant_name}' ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß", icon="üíî")
    else:
        user_favorites.add(restaurant_name)
        st.toast(f"‚ù§Ô∏è ‡πÄ‡∏û‡∏¥‡πà‡∏° '{restaurant_name}' ‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß!", icon="‚ù§Ô∏è")
    
    st.rerun() 

def add_to_history():
    query = st.session_state.search_input_key.strip()
    if query and query not in st.session_state.search_history:
        st.session_state.search_history.insert(0, query)
        st.session_state.search_history = st.session_state.search_history[:5]

def get_star_rating_emoji(score):
    """‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (0-5) ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏î‡∏≤‡∏ß (‡πÄ‡∏ä‡πà‡∏ô ‚≠ê‚≠ê‚≠ê‚≠ê¬Ω)"""
    full_star = "‚≠ê"
    half_star = "¬Ω"
    empty_star = "‚òÜ"
    score = round(score * 2) / 2 
    
    stars = ""
    for i in range(1, 6):
        if score >= i:
            stars += full_star
        elif score == i - 0.5:
            stars += half_star
        else:
            stars += empty_star
            
    return stars

# -------------------------------
# üì¶ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà)
# -------------------------------
# ‚ùó‚ùó ‡πÉ‡∏ä‡πâ‡∏ü‡∏¥‡∏•‡∏î‡πå "Town" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ Google Maps ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô ‚ùó‚ùó
restaurants_raw = [
    {"‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô": "‡∏Ñ‡∏£‡∏±‡∏ß‡∏≠‡∏≤‡∏Å‡∏π‡πã", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó": "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢ / ‡∏ã‡∏µ‡∏ü‡∏π‡πâ‡∏î", "‡∏£‡∏≤‡∏Ñ‡∏≤": "‡∏ø250‚Äì450", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠": "083-966-9997", "Town": "‡∏Å‡∏ö‡∏¥‡∏ô‡∏ó‡∏£‡πå‡∏ö‡∏∏‡∏£‡∏µ"}, 
    {"‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô": "Cafe Kantary 304", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó": "‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà & ‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà", "‡∏£‡∏≤‡∏Ñ‡∏≤": "‡∏ø90‚Äì200", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠": "037-239-777", "Town": "‡∏®‡∏£‡∏µ‡∏°‡∏´‡∏≤‡πÇ‡∏û‡∏ò‡∏¥"}, 
    {"‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô": "‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡∏Å‡∏≤‡∏Å‡∏´‡∏°‡∏π‡∏•‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏ö‡∏π‡∏£‡∏ì‡πå", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó": "‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß / ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô", "‡∏£‡∏≤‡∏Ñ‡∏≤": "‡∏ø50‚Äì100", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠": "089-995-8359", "Town": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ"}, 
    {"‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô": "‡∏ã‡∏¥‡∏ô‡∏à‡πà‡∏≤‡∏ß2", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó": "‡πÑ‡∏ó‡∏¢ & ‡πÄ‡∏ß‡∏µ‡∏¢‡∏î‡∏ô‡∏≤‡∏°", "‡∏£‡∏≤‡∏Ñ‡∏≤": "‡∏ø100‚Äì250", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠": "086-567-8901", "Town": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ"}, 
    {"‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô": "Bloom Restaurant Siamdasada", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó": "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ü‡∏¥‡∏ß‡∏ä‡∏±‡πà‡∏ô / ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢", "‡∏£‡∏≤‡∏Ñ‡∏≤": "‡∏ø300‚Äì600", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠": "037-216-800", "Town": "‡πÄ‡∏Ç‡∏≤‡πÉ‡∏´‡∏ç‡πà‡∏ù‡∏±‡πà‡∏á‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ"}, 
    {"‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô": "‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏≤‡∏¢‡∏ï‡∏¥‡∏ì‡∏ì‡πå", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó": "‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß / ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô", "‡∏£‡∏≤‡∏Ñ‡∏≤": "‡∏ø50‚Äì100", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠": "096-618-5163", "Town": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ"}, 
    {"‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô": "‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡πÄ‡∏Æ‡∏≤‡∏™‡πå 304", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó": "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏µ‡∏™‡∏≤‡∏ô / ‡∏à‡∏¥‡πâ‡∏°‡∏à‡∏∏‡πà‡∏°", "‡∏£‡∏≤‡∏Ñ‡∏≤": "‡∏ø150‚Äì300", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠": "096-383-8183", "Town": "‡∏®‡∏£‡∏µ‡∏°‡∏´‡∏≤‡πÇ‡∏û‡∏ò‡∏¥"}, 
    {"‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô": "Myrrh Cafe (‡∏°‡∏≤‡∏¢‡∏£‡πå ‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà)", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó": "‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà / ‡∏Å‡∏≤‡πÅ‡∏ü / ‡∏ß‡∏¥‡∏ß‡πÄ‡∏Ç‡∏≤", "‡∏£‡∏≤‡∏Ñ‡∏≤": "‡∏ø80‚Äì180", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠": "089-887-8125", "Town": "‡πÄ‡∏ô‡∏¥‡∏ô‡∏´‡∏≠‡∏°"},
    {"‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô": "‡πÄ‡∏à‡πä‡∏ô‡∏¥‡∏î ‡∏Å‡∏∏‡πâ‡∏á‡πÄ‡∏ú‡∏≤", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó": "‡∏Å‡∏∏‡πâ‡∏á‡πÄ‡∏ú‡∏≤ / ‡∏ã‡∏µ‡∏ü‡∏π‡πâ‡∏î", "‡∏£‡∏≤‡∏Ñ‡∏≤": "‡∏ø300‚Äì700", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠": "091-456-7890", "Town": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ"},
    {"‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô": "‡∏Ñ‡∏£‡∏±‡∏ß‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó": "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢ / ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏õ‡πà‡∏≤", "‡∏£‡∏≤‡∏Ñ‡∏≤": "‡∏ø250‚Äì500", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠": "064-678-9010", "Town": "‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á"}, 
    {"‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô": "‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß‡∏ï‡πâ‡∏°‡∏Å‡∏∏‡πä‡∏¢‡∏ô‡∏≤‡∏¢‡∏û‡∏•", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó": "‡∏Ç‡πâ‡∏≤‡∏ß‡∏ï‡πâ‡∏° / ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢", "‡∏£‡∏≤‡∏Ñ‡∏≤": "‡∏ø100‚Äì300", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠": "065-123-4560", "Town": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ"}, 
    {"‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô": "‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡πÑ‡∏ó‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó": "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡πÇ‡∏ö‡∏£‡∏≤‡∏ì / ‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®", "‡∏£‡∏≤‡∏Ñ‡∏≤": "‡∏ø300‚Äì600", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠": "086-234-5670", "Town": "‡πÄ‡∏ô‡∏¥‡∏ô‡∏´‡∏≠‡∏°"}, 
    {"‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô": "‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡∏ï‡πâ‡∏°‡∏¢‡∏≥‡πÇ‡∏ö‡∏£‡∏≤‡∏ì", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó": "‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß / ‡∏ï‡πâ‡∏°‡∏¢‡∏≥", "‡∏£‡∏≤‡∏Ñ‡∏≤": "‡∏ø50‚Äì100", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠": "083-419-4411", "Town": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ"}, 
    {"‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô": "‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡πÑ‡∏ó‡∏¢‡∏Ñ‡∏∏‡∏ì‡∏¢‡πà‡∏≤", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó": "‡∏Ç‡∏ô‡∏°‡πÑ‡∏ó‡∏¢ / ‡∏ô‡πâ‡∏≥‡∏Å‡∏∞‡∏ó‡∏¥", "‡∏£‡∏≤‡∏Ñ‡∏≤": "‡∏ø40‚Äì80", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠": "089-789-0120", "Town": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ"}, 
    {"‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô": "‡∏Ç‡πâ‡∏≤‡∏ß‡∏°‡∏±‡∏ô‡πÑ‡∏Å‡πà‡∏ï‡∏≠‡∏ô‡∏Æ‡∏Å‡πÄ‡∏Å‡∏µ‡πâ‡∏¢‡∏ô", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó": "‡∏Ç‡πâ‡∏≤‡∏ß‡∏°‡∏±‡∏ô‡πÑ‡∏Å‡πà / ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏µ‡∏ô", "‡∏£‡∏≤‡∏Ñ‡∏≤": "‡∏ø60‚Äì120", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠": "037-216-919", "Town": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ"}, 
]

# ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå Google Maps ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á
restaurants = []
for r in restaurants_raw:
    # ‚ùó ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô + ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠
    r["‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà"] = create_google_maps_url(r["‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô"], r["Town"])
    restaurants.append(r)


# -------------------------------
# üßæ ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö / ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
# -------------------------------
if not st.session_state.logged_in:
    st.title("üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö / ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å")
    tab1, tab2 = st.tabs(["‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö", "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å"])

    with tab1:
        username = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ", key="login_user")
        password = st.text_input("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô", type="password", key="login_pass")
        # ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (Primary style - ‡∏™‡∏µ‡∏™‡πâ‡∏°)
        if st.button("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö"):
            if username in st.session_state.users and st.session_state.users[username] == password:
                st.session_state.logged_in = True
                st.session_state.current_user = username
                st.session_state.view_mode = "all" 
                st.success(f"‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö {username} ‚úÖ")
                st.rerun()
            else:
                st.error("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á")

    with tab2:
        new_user = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà", key="reg_user")
        new_pass = st.text_input("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà", type="password", key="reg_pass")
        # ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (Primary style - ‡∏™‡∏µ‡∏™‡πâ‡∏°)
        if st.button("‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å"):
            if new_user in st.session_state.users:
                st.warning("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß")
            elif new_user and new_pass:
                st.session_state.users[new_user] = new_pass
                st.session_state.logged_in = True 
                st.session_state.current_user = new_user
                st.session_state.view_mode = "all"
                st.success("‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚úÖ")
                st.rerun()
            else:
                st.error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö")
    st.stop()

# -------------------------------
# üîì ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
# -------------------------------
with st.sidebar:
    st.write(f"üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: **{st.session_state.current_user}**")
    # ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (Secondary style - ‡∏°‡∏µ‡∏Ç‡∏≠‡∏ö‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏°)
    if st.button("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö", use_container_width=True):
        st.session_state.logged_in = False
        st.session_state.current_user = ""
        st.rerun()

# -------------------------------
# üîç ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô
# -------------------------------
st.title("üçΩÔ∏è ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏ô‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ (‡∏£‡πâ‡∏≤‡∏ô‡∏î‡∏±‡∏á)")

# ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
search_query = st.text_input("üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô", 
                             key="search_input_key", 
                             on_change=add_to_history) 

# -------------------------------
# üéØ ‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á
# -------------------------------
current_user_favorites = st.session_state.favorites.get(st.session_state.current_user, set())

# üÜï ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
col_all, col_fav, _ = st.columns([1, 1, 2])

with col_all:
    # ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Secondary style - ‡∏°‡∏µ‡∏Ç‡∏≠‡∏ö‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏°)
    if st.button("üè† ‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", disabled=(st.session_state.view_mode == "all" and not search_query.strip()), on_click=reset_search, use_container_width=True):
        pass

with col_fav:
    # ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÉ‡∏à (Secondary style - ‡∏°‡∏µ‡∏Ç‡∏≠‡∏ö‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏°)
    fav_count = len(current_user_favorites)
    if st.button(f"‚ù§Ô∏è ‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÉ‡∏à ({fav_count})", disabled=(st.session_state.view_mode == "favorites" and not search_query.strip()), on_click=switch_to_favorites, use_container_width=True):
        pass

st.markdown("---")


if st.session_state.view_mode == "favorites":
    all_restaurants_to_display = [r for r in restaurants if r["‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô"] in current_user_favorites]
else:
    all_restaurants_to_display = restaurants

# ‡∏Å‡∏£‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£
filtered_restaurants = []
if search_query.strip():
    for r in all_restaurants_to_display:
        if search_query.lower() in r["‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô"].lower() or search_query.lower() in r["‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó"].lower():
            filtered_restaurants.append(r)
else:
    filtered_restaurants = all_restaurants_to_display 

# üîÑ ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏¢‡∏π‡πà)
is_search_active = search_query.strip()
is_not_all_mode = st.session_state.view_mode != "all"

# ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÉ‡∏î‡πÜ
if is_search_active:
    
    button_label = "‚¨ÖÔ∏è ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
    if is_not_all_mode:
        button_label = "‚¨ÖÔ∏è ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÉ‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" 

    # ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö (Secondary style - ‡∏°‡∏µ‡∏Ç‡∏≠‡∏ö‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏°)
    if st.button(button_label, on_click=set_search_from_button, args=("",), use_container_width=True): 
        pass
        
    st.markdown("---")

# ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏Å‡∏£‡∏≠‡∏á
if (search_query.strip() and not filtered_restaurants) or (st.session_state.view_mode == "favorites" and not current_user_favorites and not search_query.strip()):
    if st.session_state.view_mode == "favorites":
        st.warning("‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏î‡πÉ‡∏à‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏î‡πÜ ü§ç")
    else:
        st.warning(f"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ **'{search_query}'**")

# ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á
if filtered_restaurants:
    for r in filtered_restaurants:
        # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏±‡∏ß‡πÉ‡∏à
        is_fav = r["‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô"] in current_user_favorites
        heart_icon = "‚ù§Ô∏è" if is_fav else "ü§ç"
        
        # ‡πÉ‡∏ä‡πâ st.columns ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÉ‡∏à‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
        col_title, col_fav_btn = st.columns([3, 1])
        
        with col_title:
            st.subheader(f"üè† {r['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô']}")
        
        with col_fav_btn:
            # ‡∏õ‡∏∏‡πà‡∏° Favorite (Secondary style - ‡∏°‡∏µ‡∏Ç‡∏≠‡∏ö‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏°)
            st.button(
                f"{heart_icon} Favorite", 
                key=f"fav_btn_{r['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô']}", 
                on_click=toggle_favorite, 
                args=(r["‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô"],),
                use_container_width=True
            )

        # ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠
        st.markdown(f"**üìû ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:** **{r['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠']}**") # ‡πÄ‡∏ô‡πâ‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠
        st.markdown(f"**‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:** {r['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó']} | **‡∏£‡∏≤‡∏Ñ‡∏≤:** {r['‡∏£‡∏≤‡∏Ñ‡∏≤']}")
        
        # ‚ùó ‡πÉ‡∏ä‡πâ st.link_button ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î Google Maps ‡∏à‡∏£‡∏¥‡∏á (‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô) 
        # ‡∏õ‡∏∏‡πà‡∏° Link Button (Secondary style - ‡∏°‡∏µ‡∏Ç‡∏≠‡∏ö‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏°)
        st.link_button(
            "üåê ‡πÄ‡∏õ‡∏¥‡∏î Google Maps", 
            url=r['‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà'], # URL ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)
            use_container_width=True
        )

        # ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
        ratings = [rev["‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"] for rev in st.session_state.reviews if rev["‡∏£‡πâ‡∏≤‡∏ô"] == r["‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô"]]
        if ratings:
            avg = sum(ratings) / len(ratings)
            avg_rounded = round(avg, 2)
            stars_emoji = get_star_rating_emoji(avg) 
            st.markdown(f"**‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:** {stars_emoji} **{avg_rounded}** ({len(ratings)} ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß)")
        else:
            st.markdown("**‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:** ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô")

        # ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
        all_comments = [rev for rev in st.session_state.reviews if rev["‡∏£‡πâ‡∏≤‡∏ô"] == r["‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô"]]
        if all_comments:
            with st.expander(f"‡∏î‡∏π‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ({len(all_comments)})"):
                for comment_item in all_comments:
                    comment_stars = get_star_rating_emoji(comment_item['‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'])
                    st.info(f"**{comment_item['‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ']}** | {comment_stars}\n\n{comment_item['‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô']}")


        # ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏£‡∏µ‡∏ß‡∏¥‡∏ß
        with st.form(f"form_{r['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô']}"):
            st.markdown("### üìù ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ")
            rating = st.slider("‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏î‡∏≤‡∏ß)", 1, 5, 3, key=f"rating_{r['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô']}")
            comment = st.text_area("‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô", key=f"comment_{r['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô']}")
            # ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß (Primary style - ‡∏™‡∏µ‡∏™‡πâ‡∏°)
            submitted = st.form_submit_button("‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß") 

            if submitted:
                if not comment:
                    st.error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß")
                else:
                    st.session_state.reviews.append({
                        "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ": st.session_state.current_user,
                        "‡∏£‡πâ‡∏≤‡∏ô": r["‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô"],
                        "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": rating,
                        "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô": comment,
                    })
                    st.success(f"‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô '{r['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô']}' ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß!")
                    st.rerun()

        st.markdown("---")
